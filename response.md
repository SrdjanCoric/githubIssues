[{"url":"https://api.github.com/repos/rails/rails/issues/42932","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42932/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42932/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42932/events","html_url":"https://github.com/rails/rails/pull/42932","id":958172344,"node_id":"MDExOlB1bGxSZXF1ZXN0NzAxNDkwNDg1","number":42932,"title":"Fix saving `DateTime::Infinity` and `Date::Infinity` with PostgreSQL.","user":{"login":"intrip","id":1753245,"node_id":"MDQ6VXNlcjE3NTMyNDU=","avatar_url":"https://avatars.githubusercontent.com/u/1753245?v=4","gravatar_id":"","url":"https://api.github.com/users/intrip","html_url":"https://github.com/intrip","followers_url":"https://api.github.com/users/intrip/followers","following_url":"https://api.github.com/users/intrip/following{/other_user}","gists_url":"https://api.github.com/users/intrip/gists{/gist_id}","starred_url":"https://api.github.com/users/intrip/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/intrip/subscriptions","organizations_url":"https://api.github.com/users/intrip/orgs","repos_url":"https://api.github.com/users/intrip/repos","events_url":"https://api.github.com/users/intrip/events{/privacy}","received_events_url":"https://api.github.com/users/intrip/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":1072773639,"node_id":"MDU6TGFiZWwxMDcyNzczNjM5","url":"https://api.github.com/repos/rails/rails/labels/ready","name":"ready","color":"fef2c0","default":false,"description":"PRs ready to merge"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-08-02T13:56:21Z","updated_at":"2021-08-02T15:47:30Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42932","html_url":"https://github.com/rails/rails/pull/42932","diff_url":"https://github.com/rails/rails/pull/42932.diff","patch_url":"https://github.com/rails/rails/pull/42932.patch"},"body":"### Summary\r\n\r\nSaving `DateTime::Infinity` and `Date::Infinity` now works correctly in PostgreSQL:\r\n\r\n```ruby\r\nPost.create!(date: Date::Infinity.new).date\r\n=>\r\nInfinity\r\n```\r\n\r\nPlease note that providing the class (`DateTime::Infinity`) instead of the instance (`DateTime::Infinity.new`) is not supported.\r\n\r\nFixes https://github.com/rails/rails/issues/40595\r\n\r\n<!-- Provide a general description of the code changes in your pull\r\nrequest... were there any bugs you had fixed? If so, mention them. If\r\nthese bugs have open GitHub issues, be sure to tag them here as well,\r\nto keep the conversation linked together. -->\r\n\r\n<!-- If there's anything else that's important and relevant to your pull\r\nrequest, mention that information here. This could include\r\nbenchmarks, or other information.\r\n\r\nIf you are updating any of the CHANGELOG files or are asked to update the\r\nCHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.\r\n\r\nFinally, if your pull request affects documentation or any non-code\r\nchanges, guidelines for those changes are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)\r\n\r\nThanks for contributing to Rails! -->\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42930","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42930/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42930/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42930/events","html_url":"https://github.com/rails/rails/issues/42930","id":958006090,"node_id":"MDU6SXNzdWU5NTgwMDYwOTA=","number":42930,"title":"Instrument ActiveStorage analyzer","user":{"login":"shouichi","id":99586,"node_id":"MDQ6VXNlcjk5NTg2","avatar_url":"https://avatars.githubusercontent.com/u/99586?v=4","gravatar_id":"","url":"https://api.github.com/users/shouichi","html_url":"https://github.com/shouichi","followers_url":"https://api.github.com/users/shouichi/followers","following_url":"https://api.github.com/users/shouichi/following{/other_user}","gists_url":"https://api.github.com/users/shouichi/gists{/gist_id}","starred_url":"https://api.github.com/users/shouichi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shouichi/subscriptions","organizations_url":"https://api.github.com/users/shouichi/orgs","repos_url":"https://api.github.com/users/shouichi/repos","events_url":"https://api.github.com/users/shouichi/events{/privacy}","received_events_url":"https://api.github.com/users/shouichi/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-08-02T10:37:05Z","updated_at":"2021-08-02T15:56:24Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Background:\r\n\r\nWe use google cloud trace to instrument our rails app. We see \"jumps\" between spans when running ActiveStorage analyzers. It seems that ActiveStorage publishes events when downloading/uploading blobs but does not publish events when running analyzers. As a result, we failed to trace analyzers and see \"jumps between spans.\r\n\r\nSolution:\r\n\r\nPublish events when running ActiveStorage analyzers so that the tracer can subscribe.\r\n\r\nThanks in advance.","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42929","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42929/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42929/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42929/events","html_url":"https://github.com/rails/rails/pull/42929","id":957594212,"node_id":"MDExOlB1bGxSZXF1ZXN0NzAwOTkwNjky","number":42929,"title":"Add option to configure digest in ActiveRecord Encryption, default to SHA256","user":{"login":"jorgemanrubia","id":129938,"node_id":"MDQ6VXNlcjEyOTkzOA==","avatar_url":"https://avatars.githubusercontent.com/u/129938?v=4","gravatar_id":"","url":"https://api.github.com/users/jorgemanrubia","html_url":"https://github.com/jorgemanrubia","followers_url":"https://api.github.com/users/jorgemanrubia/followers","following_url":"https://api.github.com/users/jorgemanrubia/following{/other_user}","gists_url":"https://api.github.com/users/jorgemanrubia/gists{/gist_id}","starred_url":"https://api.github.com/users/jorgemanrubia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jorgemanrubia/subscriptions","organizations_url":"https://api.github.com/users/jorgemanrubia/orgs","repos_url":"https://api.github.com/users/jorgemanrubia/repos","events_url":"https://api.github.com/users/jorgemanrubia/events{/privacy}","received_events_url":"https://api.github.com/users/jorgemanrubia/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-08-01T21:52:02Z","updated_at":"2021-08-02T16:09:16Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42929","html_url":"https://github.com/rails/rails/pull/42929","diff_url":"https://github.com/rails/rails/pull/42929.diff","patch_url":"https://github.com/rails/rails/pull/42929.patch"},"body":"Rails 7 uses `SHA256` as the [new default digest](https://github.com/rails/rails/pull/41043). With this change, Active Record Encryption will enforce using `SHA256` too. Before, it was initializing with `SHA1` due to the initialization sequence described in #42922.\r\n\r\nThe new option be configured with:\r\n\r\n```ruby\r\nconfig.active_record.encryption.hash_digest_class = OpenSSL::Digest::SHA1\r\n```\r\n\r\nI added a separated option for Active Record encryption because we need it to be stable. If not, it could happen that, if we set a new default for Rails, it would invalidate existing encrypted data (which is essentially when we changed the default digest for 6.1 apps using encryption). We use the digest to derive keys so, if it changes, keys change and existing data can't be decrypted.\r\n\r\n`SHA256` is the new default in Rails 7.0 so we adopt it for Active Record encryption, which is a 7.0 feature. I am also setting it retroactively to `SHA1` for 6.0 defaults, so that early adopters of encryption before the default changed don't have to tweak the new config to decrypt with existing data.\r\n\r\nFix #42922 \r\n\r\ncc @ghiculescu @boomer196 \r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42927","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42927/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42927/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42927/events","html_url":"https://github.com/rails/rails/issues/42927","id":957250497,"node_id":"MDU6SXNzdWU5NTcyNTA0OTc=","number":42927,"title":"`ActiveStorage::Attached::Changes::CreateOne#upload` doesn't support `Rack::Test::UploadedFile`s initialized with `StringIO` contents","user":{"login":"noon-ng","id":447488,"node_id":"MDQ6VXNlcjQ0NzQ4OA==","avatar_url":"https://avatars.githubusercontent.com/u/447488?v=4","gravatar_id":"","url":"https://api.github.com/users/noon-ng","html_url":"https://github.com/noon-ng","followers_url":"https://api.github.com/users/noon-ng/followers","following_url":"https://api.github.com/users/noon-ng/following{/other_user}","gists_url":"https://api.github.com/users/noon-ng/gists{/gist_id}","starred_url":"https://api.github.com/users/noon-ng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/noon-ng/subscriptions","organizations_url":"https://api.github.com/users/noon-ng/orgs","repos_url":"https://api.github.com/users/noon-ng/repos","events_url":"https://api.github.com/users/noon-ng/events{/privacy}","received_events_url":"https://api.github.com/users/noon-ng/received_events","type":"User","site_admin":false},"labels":[{"id":664533972,"node_id":"MDU6TGFiZWw2NjQ1MzM5NzI=","url":"https://api.github.com/repos/rails/rails/labels/activestorage","name":"activestorage","color":"bfd4f2","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-07-31T13:58:47Z","updated_at":"2021-08-02T10:24:36Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# frozen_string_literal: true\r\n\r\nrequire \"bundler/inline\"\r\n\r\ngemfile(true) do\r\n  source \"https://rubygems.org\"\r\n\r\n  git_source(:github) { |repo| \"https://github.com/#{repo}.git\" }\r\n\r\n  # Activate the gem you are reporting the issue against.\r\n  gem \"rails\", \"~>6.1.0\"\r\n  gem \"sqlite3\"\r\nend\r\n\r\nrequire \"active_record/railtie\"\r\nrequire \"active_storage/engine\"\r\nrequire \"tmpdir\"\r\n\r\nclass TestApp < Rails::Application\r\n  config.root = __dir__\r\n  config.hosts << \"example.org\"\r\n  config.eager_load = false\r\n  config.session_store :cookie_store, key: \"cookie_store_key\"\r\n  secrets.secret_key_base = \"secret_key_base\"\r\n\r\n  config.logger = Logger.new($stdout)\r\n  Rails.logger  = config.logger\r\n\r\n  config.active_storage.service = :local\r\n  config.active_storage.service_configurations = {\r\n    local: {\r\n      root: Dir.tmpdir,\r\n      service: \"Disk\"\r\n    }\r\n  }\r\nend\r\n\r\nENV[\"DATABASE_URL\"] = \"sqlite3::memory:\"\r\n\r\nRails.application.initialize!\r\n\r\nrequire ActiveStorage::Engine.root.join(\"db/migrate/20170806125915_create_active_storage_tables.rb\").to_s\r\n\r\nActiveRecord::Schema.define do\r\n  CreateActiveStorageTables.new.change\r\n\r\n  create_table :users, force: true\r\nend\r\n\r\nclass User < ActiveRecord::Base\r\n  has_one_attached :profile\r\nend\r\n\r\nrequire \"minitest/autorun\"\r\n\r\nclass BugTest < Minitest::Test\r\n  def test_uploaded_file_with_string_io_contents\r\n    user = User.create!(\r\n      profile: Rack::Test::UploadedFile.new(\r\n        StringIO.new(\"dummy\"),\r\n        original_filename: \"dummy.txt\"\r\n      )\r\n    )\r\n\r\n    assert_equal \"dummy\", user.profile.download\r\n  end\r\n\r\n  def test_uploaded_file_with_file_contents\r\n    dummy_file_path = \"#{Dir.tmpdir}/dummy.txt\"\r\n    File.open(dummy_file_path, \"w+\") { |file| file << \"dummy\" }\r\n\r\n    user = User.create!(profile: Rack::Test::UploadedFile.new(dummy_file_path))\r\n\r\n    assert_equal \"dummy\", user.profile.download\r\n\r\n    File.unlink(dummy_file_path)\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\nBoth tests should pass.\r\n\r\n### Actual behavior\r\nOnly `test_uploaded_file_with_file_contents` passes; `test_uploaded_file_with_string_io_contents` errors out with the following stacktrace:\r\n\r\n```\r\nError:\r\nBugTest#test_uploaded_file_with_string_io_contents:\r\nNoMethodError: private method `open' called for #<StringIO:0x00007f9157be4b38>\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/rack-test-1.1.0/lib/rack/test/uploaded_file.rb:47:in `public_send'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/rack-test-1.1.0/lib/rack/test/uploaded_file.rb:47:in `method_missing'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activestorage-6.1.4/lib/active_storage/attached/changes/create_one.rb:58:in `find_or_build_blob'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activestorage-6.1.4/lib/active_storage/attached/changes/create_one.rb:20:in `blob'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activestorage-6.1.4/lib/active_storage/attached/changes/create_one.rb:12:in `initialize'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activestorage-6.1.4/lib/active_storage/attached/model.rb:65:in `new'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activestorage-6.1.4/lib/active_storage/attached/model.rb:65:in `profile='\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activemodel-6.1.4/lib/active_model/attribute_assignment.rb:49:in `public_send'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activemodel-6.1.4/lib/active_model/attribute_assignment.rb:49:in `_assign_attribute'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activerecord-6.1.4/lib/active_record/attribute_assignment.rb:21:in `block in _assign_attributes'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activerecord-6.1.4/lib/active_record/attribute_assignment.rb:13:in `each'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activerecord-6.1.4/lib/active_record/attribute_assignment.rb:13:in `_assign_attributes'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activemodel-6.1.4/lib/active_model/attribute_assignment.rb:34:in `assign_attributes'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activerecord-6.1.4/lib/active_record/core.rb:510:in `initialize'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activerecord-6.1.4/lib/active_record/inheritance.rb:72:in `new'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activerecord-6.1.4/lib/active_record/inheritance.rb:72:in `new'\r\n    /Users/ngc/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activerecord-6.1.4/lib/active_record/persistence.rb:54:in `create!'\r\n    active_storage_gem.rb:58:in `test_uploaded_file_with_string_io_contents'\r\n```\r\n\r\n### System configuration\r\n**Rails version**:\r\n6.1.4\r\n\r\n**rack-test version**:\r\n1.1.0\r\n\r\n**Ruby version**:\r\nruby 2.7.2p137 (2020-10-01 revision 5445e04352) [x86_64-darwin20]","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42926","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42926/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42926/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42926/events","html_url":"https://github.com/rails/rails/pull/42926","id":957248440,"node_id":"MDExOlB1bGxSZXF1ZXN0NzAwNzEyNjM5","number":42926,"title":"Document Active Storage implicit transformations [ci-skip]","user":{"login":"brenogazzola","id":1793280,"node_id":"MDQ6VXNlcjE3OTMyODA=","avatar_url":"https://avatars.githubusercontent.com/u/1793280?v=4","gravatar_id":"","url":"https://api.github.com/users/brenogazzola","html_url":"https://github.com/brenogazzola","followers_url":"https://api.github.com/users/brenogazzola/followers","following_url":"https://api.github.com/users/brenogazzola/following{/other_user}","gists_url":"https://api.github.com/users/brenogazzola/gists{/gist_id}","starred_url":"https://api.github.com/users/brenogazzola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brenogazzola/subscriptions","organizations_url":"https://api.github.com/users/brenogazzola/orgs","repos_url":"https://api.github.com/users/brenogazzola/repos","events_url":"https://api.github.com/users/brenogazzola/events{/privacy}","received_events_url":"https://api.github.com/users/brenogazzola/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2021-07-31T13:45:27Z","updated_at":"2021-08-02T02:29:20Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42926","html_url":"https://github.com/rails/rails/pull/42926","diff_url":"https://github.com/rails/rails/pull/42926.diff","patch_url":"https://github.com/rails/rails/pull/42926.patch"},"body":"### Summary\r\nWhen a `variant` is requested, Active Storage automatically applies a couple of transformations, but those are not explained anywhere:\r\n\r\n1. Content types that are not considered `web images`, but are `variable`, will be converted to PNG.\r\n2. If no `quality` is specified, the variant processor's default quality for the format will be used.  \r\n\r\nThis PR adds this to the guide.\r\n\r\n### Other Information\r\nI've opened #42686 to make this behavior more explicit, fine tune it for web images and allow developers to change the defaults.\r\n\r\nItem 2 specifically might cause unexpected results, as demonstrated below. The `demo2.jpg` image ends up with a larger file size despite being `demo.jpg` shrunk down, because ImageMagick uses quality 92 by default:\r\n\r\n```\r\n$ cd /tmp\r\n$ wget https://s3.sa-east-1.amazonaws.com/cdn.festalab.com.br/development/demo.heic\r\n$ exiftool demo.heic | grep \"Image Size\"\r\nImage Size                 : 4032x3024\r\n\r\n$ convert demo.heic -quality 50 demo.jpg \r\n$ convert demo.jpg -resize \"3000x\" demo2.jpg\r\n$ du -h demo*\r\n2.0M    demo.heic\r\n696K    demo.jpg\r\n704K    demo2.jpg\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42924","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42924/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42924/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42924/events","html_url":"https://github.com/rails/rails/issues/42924","id":957183954,"node_id":"MDU6SXNzdWU5NTcxODM5NTQ=","number":42924,"title":"no locale in params from ActionMailer previews","user":{"login":"dorianmariefr","id":58794487,"node_id":"MDQ6VXNlcjU4Nzk0NDg3","avatar_url":"https://avatars.githubusercontent.com/u/58794487?v=4","gravatar_id":"","url":"https://api.github.com/users/dorianmariefr","html_url":"https://github.com/dorianmariefr","followers_url":"https://api.github.com/users/dorianmariefr/followers","following_url":"https://api.github.com/users/dorianmariefr/following{/other_user}","gists_url":"https://api.github.com/users/dorianmariefr/gists{/gist_id}","starred_url":"https://api.github.com/users/dorianmariefr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dorianmariefr/subscriptions","organizations_url":"https://api.github.com/users/dorianmariefr/orgs","repos_url":"https://api.github.com/users/dorianmariefr/repos","events_url":"https://api.github.com/users/dorianmariefr/events{/privacy}","received_events_url":"https://api.github.com/users/dorianmariefr/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-07-31T06:32:34Z","updated_at":"2021-07-31T06:32:34Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n```ruby\r\nclass ApplicationMailer < ActionMailer::Base\r\n  default from: \"Socializus <contact@socializus.app>\"\r\n  layout \"mailer\"\r\n\r\n  rescue_from ActiveRecord::RecordNotFound do |exception|\r\n    Rails.logger.info(exception)\r\n  end\r\n\r\n  rescue_from ActiveJob::DeserializationError do |exception|\r\n    Rails.logger.info(exception)\r\n  end\r\n\r\n  has_history\r\n  track_clicks campaign: -> { \"#{controller_path}-#{action_name}\" }\r\n\r\n  def with_user(user, &block)\r\n    Time.use_zone(user.timezone) do\r\n      I18n.with_locale(params[\"locale\"] || user.locale) { block.call }\r\n    end\r\n  end\r\nend\r\n```\r\n\r\n### Expected behavior\r\n\r\n`params['locale']` contains the locale chosen in the preview interface\r\n\r\n### Actual behavior\r\n\r\nparams only contains the user for instance, no locale\r\n\r\n### System configuration\r\n\r\n**Rails version**: Rails 6.1.4\r\n\r\n**Ruby version**: ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-darwin20]\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42923","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42923/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42923/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42923/events","html_url":"https://github.com/rails/rails/issues/42923","id":957173078,"node_id":"MDU6SXNzdWU5NTcxNzMwNzg=","number":42923,"title":"`on_rescue ActiveStorage::FileNotFoundError, :delete`","user":{"login":"dorianmariefr","id":58794487,"node_id":"MDQ6VXNlcjU4Nzk0NDg3","avatar_url":"https://avatars.githubusercontent.com/u/58794487?v=4","gravatar_id":"","url":"https://api.github.com/users/dorianmariefr","html_url":"https://github.com/dorianmariefr","followers_url":"https://api.github.com/users/dorianmariefr/followers","following_url":"https://api.github.com/users/dorianmariefr/following{/other_user}","gists_url":"https://api.github.com/users/dorianmariefr/gists{/gist_id}","starred_url":"https://api.github.com/users/dorianmariefr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dorianmariefr/subscriptions","organizations_url":"https://api.github.com/users/dorianmariefr/orgs","repos_url":"https://api.github.com/users/dorianmariefr/repos","events_url":"https://api.github.com/users/dorianmariefr/events{/privacy}","received_events_url":"https://api.github.com/users/dorianmariefr/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-07-31T05:15:11Z","updated_at":"2021-08-02T07:38:28Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n\r\n- have an app with active storage\r\n\r\n### Expected behavior\r\n\r\n- no errors from active storage\r\n\r\n### Actual behavior\r\n\r\n- `ActiveStorage::FileNotFoundError`s\r\n\r\n### System configuration\r\n\r\n**Rails version**: Rails 6.1.4\r\n\r\n**Ruby version**: ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-darwin20]\r\n\r\nI'm not sure which file I should delete and how to not receive this type of errors\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42922","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42922/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42922/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42922/events","html_url":"https://github.com/rails/rails/issues/42922","id":957126926,"node_id":"MDU6SXNzdWU5NTcxMjY5MjY=","number":42922,"title":"ActiveRecord Encryption initializes with SHA1 and then new Rails 7 default switches to SHA256","user":{"login":"boomer196","id":6631628,"node_id":"MDQ6VXNlcjY2MzE2Mjg=","avatar_url":"https://avatars.githubusercontent.com/u/6631628?v=4","gravatar_id":"","url":"https://api.github.com/users/boomer196","html_url":"https://github.com/boomer196","followers_url":"https://api.github.com/users/boomer196/followers","following_url":"https://api.github.com/users/boomer196/following{/other_user}","gists_url":"https://api.github.com/users/boomer196/gists{/gist_id}","starred_url":"https://api.github.com/users/boomer196/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boomer196/subscriptions","organizations_url":"https://api.github.com/users/boomer196/orgs","repos_url":"https://api.github.com/users/boomer196/repos","events_url":"https://api.github.com/users/boomer196/events{/privacy}","received_events_url":"https://api.github.com/users/boomer196/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-07-31T00:01:49Z","updated_at":"2021-08-02T15:27:00Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"\r\n`ActiveRecord::Railtie` initialization fires before `ActiveSupport::Railtie`\r\n\r\nIn `Rails::Application::Configuration#load_defaults(7.0)` it sets [`active_support.key_generator_hash_digest_class = OpenSSL::Digest::SHA256`](https://github.com/rails/rails/blob/c3664b0c2b509fc0a47929f42afbd716959c8f4c/railties/lib/rails/application/configuration.rb#L213)\r\n\r\nThen in the `ActiveSupport::Railtie` it sets [`ActiveSupport::KeyGenerator.hash_digest_class = active_support.key_generator_hash_digest_class`](https://github.com/rails/rails/blob/c3664b0c2b509fc0a47929f42afbd716959c8f4c/activesupport/lib/active_support/railtie.rb#L114)\r\n\r\nHowever, the `ActiveRecord::Railtie` configures `ActiveRecord::Encryption` before this configuration change happens.\r\n\r\nWhat this causes is the `ActiveRecord::Encryption::Configurable.configure` to set the [`context.key_provider = ActiveRecord::Encryption::DerivedSecretKeyProvider.new(primary_key)`](https://github.com/rails/rails/blob/c3664b0c2b509fc0a47929f42afbd716959c8f4c/activerecord/lib/active_record/encryption/configurable.rb#L25), which uses the `ActiveSupport::KeyGenerator` from [`ActiveRecord::Encryption::KeyGenerator#derive_key_from`](https://github.com/rails/rails/blob/c3664b0c2b509fc0a47929f42afbd716959c8f4c/activerecord/lib/active_record/encryption/key_generator.rb#L33) method.  At this point it uses the classes default `hash_digest_class` of `OpenSSL::Digest::SHA1`.\r\n\r\nAfter `ActiveSupport::Railtie` runs the `ActiveSupport::KeyGenerator.hash_digest_class` changes to `OpenSSL::Digest::SHA256`\r\n\r\nI am not sure what the best fix is and there may be others, but a couple I can think of are:\r\n* `ActiveRecord::Encryption` is \"explicit\" about how it configures/uses the `ActiveSupport::KeyGenerator` and possibly adds additional options for `hash_digest_class` and `iterations`.  This removes the dependency.  It also allows the database to live past future changes to ActiveSupport defaults. \r\n* `ActiveSupport::KeyGenerator` changes it's class default to be `OpenSSL::Digest::SHA256` and the `new_framework_defaults_7_0.rb` file sets it back to `OpenSSL::Digest::SHA1`\r\n\r\n### Steps to reproduce\r\n1. Create a new rails 7 project using all rails 7 defaults (removed `new_framework_defaults_7_0.rb` file and `application.rb` changes to `config.load_defaults 7.0`)\r\n2. Configure Encryption by running `bin/rails db:encryption:init` and adding the generated credentials (`bin/rails credentials:edit`)\r\n```ruby\r\nAdd this entry to the credentials of the target environment:\r\n\r\nactive_record_encryption:\r\n  primary_key: nYeEQD0EqOKXeRMFcUq7BX6goxGt0hPq\r\n  deterministic_key: aduCGCnZWFtRIN3xc8CiM15kZKt2Az8T\r\n  key_derivation_salt: fidtmePZxQNmR6Gc4Yv7j1lko06ISaBu\r\n``` \r\n3. Start a rails console (`bin/rails console`)\r\n\r\n```ruby\r\nActiveRecord::Encryption.key_provider.encryption_key.secret\r\nprimary_key = \"nYeEQD0EqOKXeRMFcUq7BX6goxGt0hPq\"\r\nkey_derivation_salt = \"fidtmePZxQNmR6Gc4Yv7j1lko06ISaBu\"\r\nActiveRecord::Encryption::DerivedSecretKeyProvider.new(primary_key).encryption_key.secret\r\nOpenSSL::PKCS5.pbkdf2_hmac(primary_key, key_derivation_salt, 2**16, 32, OpenSSL::Digest::SHA1.new)\r\nOpenSSL::PKCS5.pbkdf2_hmac(primary_key, key_derivation_salt, 2**16, 32, OpenSSL::Digest::SHA256.new)\r\n```\r\n\r\n### Expected behavior\r\n`ActiveRecord::Encryption.key_provider.encryption_key.secret`\r\n`\\xE547G\\xE7\\x99?\\x95\\xAEX\\xE1\\xEFS\\xE9p\\x87}\\x93\\xF8\\x8A\\x9Ch\\x80\\x95#Bee\\x95\\nD\\x7F`\r\n\r\n### Actual behavior\r\n`ActiveRecord::Encryption.key_provider.encryption_key.secret`\r\n`\\x8B`\\x17k\\xA1\\xC9`:a\\x05>N\\x10\\xE4\\eYD\\xCFUh\\x10\\x9Ep\\x89\\x10\\x15vt\\xE0\\x94\\xAAN`\r\n\r\n`ActiveRecord::Encryption::DerivedSecretKeyProvider.new(primary_key).encryption_key.secret`\r\n`\\xE547G\\xE7\\x99?\\x95\\xAEX\\xE1\\xEFS\\xE9p\\x87}\\x93\\xF8\\x8A\\x9Ch\\x80\\x95#Bee\\x95\\nD\\x7F`\r\n\r\n`OpenSSL::PKCS5.pbkdf2_hmac(primary_key, key_derivation_salt, 2**16, 32, OpenSSL::Digest::SHA1.new)`\r\n`\\x8B`\\x17k\\xA1\\xC9`:a\\x05>N\\x10\\xE4\\eYD\\xCFUh\\x10\\x9Ep\\x89\\x10\\x15vt\\xE0\\x94\\xAAN`\r\n\r\n`OpenSSL::PKCS5.pbkdf2_hmac(primary_key, key_derivation_salt, 2**16, 32, OpenSSL::Digest::SHA256.new)`\r\n`\\xE547G\\xE7\\x99?\\x95\\xAEX\\xE1\\xEFS\\xE9p\\x87}\\x93\\xF8\\x8A\\x9Ch\\x80\\x95#Bee\\x95\\nD\\x7F`\r\n\r\n### System configuration\r\n**Rails version**: `7.0` (`gem 'rails', github: 'rails/rails', branch: 'main'`)\r\n\r\n**Ruby version**: `ruby 2.7.2p137`\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42921","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42921/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42921/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42921/events","html_url":"https://github.com/rails/rails/pull/42921","id":957009143,"node_id":"MDExOlB1bGxSZXF1ZXN0NzAwNTE4NzQw","number":42921,"title":"Allow #upsert_all without unique_by to use PostgreSQL unique indexes","user":{"login":"lucaspbordignon","id":11822875,"node_id":"MDQ6VXNlcjExODIyODc1","avatar_url":"https://avatars.githubusercontent.com/u/11822875?v=4","gravatar_id":"","url":"https://api.github.com/users/lucaspbordignon","html_url":"https://github.com/lucaspbordignon","followers_url":"https://api.github.com/users/lucaspbordignon/followers","following_url":"https://api.github.com/users/lucaspbordignon/following{/other_user}","gists_url":"https://api.github.com/users/lucaspbordignon/gists{/gist_id}","starred_url":"https://api.github.com/users/lucaspbordignon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucaspbordignon/subscriptions","organizations_url":"https://api.github.com/users/lucaspbordignon/orgs","repos_url":"https://api.github.com/users/lucaspbordignon/repos","events_url":"https://api.github.com/users/lucaspbordignon/events{/privacy}","received_events_url":"https://api.github.com/users/lucaspbordignon/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-07-30T19:30:06Z","updated_at":"2021-07-30T19:35:21Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42921","html_url":"https://github.com/rails/rails/pull/42921","diff_url":"https://github.com/rails/rails/pull/42921.diff","patch_url":"https://github.com/rails/rails/pull/42921.patch"},"body":"### Summary\r\n\r\nWhen trying to call a `#upsert_all` operation in an `ActiveRecord` model without passing any `:unique_by` parameter, it adds the following statement:\r\n\r\n```SQL\r\nON CONFLICT (\"id\") DO NOTHING\r\n```\r\n\r\nHowever, PostgreSQL sets the `conflict_target` as an optional parameter. When the parameter is not present, all the uniqueness indexes on the database will be used as the conflict matcher. This way, the proper way to automatically use the uniqueness indexes as stated in the documentation is using the following statement ([see more](https://www.postgresql.org/docs/9.5/sql-insert.html#SQL-ON-CONFLICT))\r\n\r\n```SQL\r\nON CONFLICT DO NOTHING\r\n```\r\n\r\nAlso, given the `#upsert_all` method is supported by both PostgreSQL and SQLite3, we must keep compatibility with SQLite3, which states that the [`conflict_target` is required on update operations](https://www.sqlite.org/lang_UPSERT.html).\r\n\r\n### Other Information\r\n\r\nMore details under #42918 ","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42920","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42920/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42920/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42920/events","html_url":"https://github.com/rails/rails/issues/42920","id":957009107,"node_id":"MDU6SXNzdWU5NTcwMDkxMDc=","number":42920,"title":"Add drop table migration on model delete instead of removing creation migration","user":{"login":"coder2000","id":27944,"node_id":"MDQ6VXNlcjI3OTQ0","avatar_url":"https://avatars.githubusercontent.com/u/27944?v=4","gravatar_id":"","url":"https://api.github.com/users/coder2000","html_url":"https://github.com/coder2000","followers_url":"https://api.github.com/users/coder2000/followers","following_url":"https://api.github.com/users/coder2000/following{/other_user}","gists_url":"https://api.github.com/users/coder2000/gists{/gist_id}","starred_url":"https://api.github.com/users/coder2000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coder2000/subscriptions","organizations_url":"https://api.github.com/users/coder2000/orgs","repos_url":"https://api.github.com/users/coder2000/repos","events_url":"https://api.github.com/users/coder2000/events{/privacy}","received_events_url":"https://api.github.com/users/coder2000/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-07-30T19:30:02Z","updated_at":"2021-07-30T19:30:02Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n1. Create a model\r\n2. Migrate database\r\n3. Delete model\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\nMigration should be created to drop table from database instead of deleting the migration to create the table. Removing the create table migration can cause issues with migrations run after model removal.\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\nMigration to create table is deleted\r\n\r\n### System configuration\r\n**Rails version**: 6.1.4\r\n\r\n**Ruby version**: 3.0.2\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42919","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42919/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42919/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42919/events","html_url":"https://github.com/rails/rails/pull/42919","id":956935864,"node_id":"MDExOlB1bGxSZXF1ZXN0NzAwNDU3MTgz","number":42919,"title":"Avoid unnecessary double string split in ActiveSupport::MessageVerifier#verified","user":{"login":"jcmfernandes","id":1144866,"node_id":"MDQ6VXNlcjExNDQ4NjY=","avatar_url":"https://avatars.githubusercontent.com/u/1144866?v=4","gravatar_id":"","url":"https://api.github.com/users/jcmfernandes","html_url":"https://github.com/jcmfernandes","followers_url":"https://api.github.com/users/jcmfernandes/followers","following_url":"https://api.github.com/users/jcmfernandes/following{/other_user}","gists_url":"https://api.github.com/users/jcmfernandes/gists{/gist_id}","starred_url":"https://api.github.com/users/jcmfernandes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcmfernandes/subscriptions","organizations_url":"https://api.github.com/users/jcmfernandes/orgs","repos_url":"https://api.github.com/users/jcmfernandes/repos","events_url":"https://api.github.com/users/jcmfernandes/events{/privacy}","received_events_url":"https://api.github.com/users/jcmfernandes/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-07-30T17:21:53Z","updated_at":"2021-08-01T00:37:14Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42919","html_url":"https://github.com/rails/rails/pull/42919","diff_url":"https://github.com/rails/rails/pull/42919.diff","patch_url":"https://github.com/rails/rails/pull/42919.patch"},"body":"### Summary\r\n\r\n<!-- Provide a general description of the code changes in your pull\r\nrequest... were there any bugs you had fixed? If so, mention them. If\r\nthese bugs have open GitHub issues, be sure to tag them here as well,\r\nto keep the conversation linked together. -->\r\n\r\n`ActiveSupport::MessageVerifier#verified` is causing `signed_message` to be split twice: first inside `#valid_message?` and then inside `#verified`. This is ultimately unnecessary.\r\n\r\n### Benchmark\r\n\r\nI renamed the current implementation of `#valid_message?` and `#verified` to `#valid_message_old?` and `#verified_old` respectively, with the latter modified to call `#valid_message_old?`. I then ran the following benchmark:\r\n\r\n```ruby\r\ndata = SecureRandom.alphanumeric(SIZE)\r\nsigned_message = ActiveSupport::MessageVerifier.new(\"Hey, I'm a secret!\").generate(data)\r\n\r\nGC.start\r\n\r\nBenchmark.ips do |x|\r\n  x.time = 10\r\n  x.warmup = 2\r\n\r\n  x.report('new verified') do\r\n    @verifier.verified(signed_message)\r\n  end\r\n  x.report('old verified') do\r\n    @verifier.verified_old(signed_message)\r\n  end\r\n\r\n  x.compare!\r\nend\r\n\r\nBenchmark.ips do |x|\r\n  x.time = 10\r\n  x.warmup = 2\r\n\r\n  x.report('new valid message') do\r\n    @verifier.valid_message?(signed_message)\r\n  end\r\n  x.report('old valid message') do\r\n    @verifier.valid_message_old?(signed_message)\r\n  end\r\n\r\n  x.compare!\r\nend\r\n```\r\n\r\nWith `SIZE = 2**12` (4 kB, approximately the maximum size of a cookie):\r\n```\r\nComparison:\r\n        new verified:    28808.8 i/s\r\n        old verified:    25400.1 i/s - 1.13x  (± 0.00) slower\r\n\r\nComparison:\r\n        new verified:    37774.6 i/s\r\n        old verified:    32482.2 i/s - 1.16x  (± 0.00) slower\r\n\r\nComparison:\r\n        new verified:    38709.1 i/s\r\n        old verified:    33416.9 i/s - 1.16x  (± 0.00) slower\r\n\r\nComparison:\r\n        new verified:    38629.5 i/s\r\n        old verified:    32879.7 i/s - 1.17x  (± 0.00) slower\r\n\r\nComparison:\r\n   old valid message:    70262.7 i/s\r\n   new valid message:    69663.3 i/s - same-ish: difference falls within error\r\n\r\nComparison:\r\n   old valid message:    69522.6 i/s\r\n   new valid message:    68408.8 i/s - same-ish: difference falls within error\r\n\r\nComparison:\r\n   new valid message:    69642.7 i/s\r\n   old valid message:    69283.1 i/s - same-ish: difference falls within error\r\n\r\nComparison:\r\n   new valid message:    69779.8 i/s\r\n   old valid message:    69510.5 i/s - same-ish: difference falls within error\r\n```\r\n\r\nWith `SIZE = 2**22` (4 MB):\r\n```\r\nComparison:\r\n        new verified:       75.0 i/s\r\n        old verified:       49.9 i/s - 1.50x  (± 0.00) slower\r\n\r\nComparison:\r\n        new verified:       70.0 i/s\r\n        old verified:       49.1 i/s - 1.43x  (± 0.00) slower\r\n\r\nComparison:\r\n        new verified:       74.6 i/s\r\n        old verified:       49.7 i/s - 1.50x  (± 0.00) slower\r\n\r\nComparison:\r\n        new verified:       40.1 i/s\r\n        old verified:       32.2 i/s - 1.25x  (± 0.00) slower\r\n\r\nComparison:\r\n   new valid message:      133.3 i/s\r\n   old valid message:      131.3 i/s - same-ish: difference falls within error\r\n\r\nComparison:\r\n   old valid message:      131.5 i/s\r\n   new valid message:      131.4 i/s - same-ish: difference falls within error\r\n\r\nComparison:\r\n   new valid message:      133.3 i/s\r\n   old valid message:      132.1 i/s - same-ish: difference falls within error\r\n\r\nComparison:\r\n   new valid message:      132.6 i/s\r\n   old valid message:      130.7 i/s - same-ish: difference falls within error\r\n```\r\n\r\nAs expected, with a larger signed message, a greater speedup.\r\n\r\n### Other Information\r\n\r\n<!-- If there's anything else that's important and relevant to your pull\r\nrequest, mention that information here. This could include\r\nbenchmarks, or other information.\r\n\r\nIf you are updating any of the CHANGELOG files or are asked to update the\r\nCHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.\r\n\r\nFinally, if your pull request affects documentation or any non-code\r\nchanges, guidelines for those changes are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)\r\n\r\nThanks for contributing to Rails! -->\r\n\r\nNone.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42918","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42918/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42918/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42918/events","html_url":"https://github.com/rails/rails/issues/42918","id":956737780,"node_id":"MDU6SXNzdWU5NTY3Mzc3ODA=","number":42918,"title":"ActiveRecord | #upsert_all without unique_by adds ID as the conflict_target in Postgres","user":{"login":"lucaspbordignon","id":11822875,"node_id":"MDQ6VXNlcjExODIyODc1","avatar_url":"https://avatars.githubusercontent.com/u/11822875?v=4","gravatar_id":"","url":"https://api.github.com/users/lucaspbordignon","html_url":"https://github.com/lucaspbordignon","followers_url":"https://api.github.com/users/lucaspbordignon/followers","following_url":"https://api.github.com/users/lucaspbordignon/following{/other_user}","gists_url":"https://api.github.com/users/lucaspbordignon/gists{/gist_id}","starred_url":"https://api.github.com/users/lucaspbordignon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucaspbordignon/subscriptions","organizations_url":"https://api.github.com/users/lucaspbordignon/orgs","repos_url":"https://api.github.com/users/lucaspbordignon/repos","events_url":"https://api.github.com/users/lucaspbordignon/events{/privacy}","received_events_url":"https://api.github.com/users/lucaspbordignon/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":41328116,"node_id":"MDU6TGFiZWw0MTMyODExNg==","url":"https://api.github.com/repos/rails/rails/labels/attached%20PR","name":"attached PR","color":"006b75","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2021-07-30T13:16:26Z","updated_at":"2021-07-30T19:31:16Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"When trying to call a `upsert_all` operation in one of the `ActiveRecord` models of my application, I've noticed that the resulting SQL inserts the statement `ON CONFLICT (\"id\") DO UPDATE`. Passing the desired index via `:unique_by` key works though.\r\n\r\nHowever, the current [documentation](https://apidock.com/rails/v6.0.0/ActiveRecord/Persistence/ClassMethods/upsert_all) of `#upsert_all` states:\r\n\r\n> By default rows are considered to be unique by every unique index on the table\r\n\r\nAlso, when executing `#insert_all` without specifying the unique index, we receive the correct SQL statement `ON CONFLICT DO NOTHING`\r\n\r\n### Expected behavior\r\nThe `#upsert_all` method, without `:unique_by` parameter to add the `ON CONFLICT DO UPDATE` SQL statement\r\n\r\n### Actual behavior\r\nThe `#upsert_all` method, without `:unique_by` parameter adds the `ON CONFLICT (\"id\") DO UPDATE` SQL statement\r\n\r\n### System configuration\r\n**Rails version**: 6.1.3\r\n\r\n**Ruby version**: 3.0.1\r\n\r\n**PostgreSQL version**: 12.4, running over AWS AuroraDB\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42916","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42916/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42916/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42916/events","html_url":"https://github.com/rails/rails/pull/42916","id":956609949,"node_id":"MDExOlB1bGxSZXF1ZXN0NzAwMTc2ODM1","number":42916,"title":"Avoid logging delayed job arguments if log_arguments set to false","user":{"login":"Alexander-Blair","id":29066290,"node_id":"MDQ6VXNlcjI5MDY2Mjkw","avatar_url":"https://avatars.githubusercontent.com/u/29066290?v=4","gravatar_id":"","url":"https://api.github.com/users/Alexander-Blair","html_url":"https://github.com/Alexander-Blair","followers_url":"https://api.github.com/users/Alexander-Blair/followers","following_url":"https://api.github.com/users/Alexander-Blair/following{/other_user}","gists_url":"https://api.github.com/users/Alexander-Blair/gists{/gist_id}","starred_url":"https://api.github.com/users/Alexander-Blair/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Alexander-Blair/subscriptions","organizations_url":"https://api.github.com/users/Alexander-Blair/orgs","repos_url":"https://api.github.com/users/Alexander-Blair/repos","events_url":"https://api.github.com/users/Alexander-Blair/events{/privacy}","received_events_url":"https://api.github.com/users/Alexander-Blair/received_events","type":"User","site_admin":false},"labels":[{"id":123812746,"node_id":"MDU6TGFiZWwxMjM4MTI3NDY=","url":"https://api.github.com/repos/rails/rails/labels/activejob","name":"activejob","color":"5319e7","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-07-30T10:15:47Z","updated_at":"2021-08-01T20:47:16Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42916","html_url":"https://github.com/rails/rails/pull/42916","diff_url":"https://github.com/rails/rails/pull/42916.diff","patch_url":"https://github.com/rails/rails/pull/42916.patch"},"body":"### Summary\r\nBuilds on the work done in https://github.com/rails/rails/pull/37660 - the arguments are stilled logged by `ActiveJob::QueueAdapters::DelayedJobAdapter::JobWrapper` - this PR prevents those arguments from being logged when `log_arguments` is set to false on the running job.\r\n\r\n<!-- If there's anything else that's important and relevant to your pull\r\nrequest, mention that information here. This could include\r\nbenchmarks, or other information.\r\n\r\nIf you are updating any of the CHANGELOG files or are asked to update the\r\nCHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.\r\n\r\nFinally, if your pull request affects documentation or any non-code\r\nchanges, guidelines for those changes are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)\r\n\r\nThanks for contributing to Rails! -->\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42914","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42914/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42914/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42914/events","html_url":"https://github.com/rails/rails/pull/42914","id":956487603,"node_id":"MDExOlB1bGxSZXF1ZXN0NzAwMDc1NDA3","number":42914,"title":"make Time.with_zone the prefered alias instead of Time.use_zone","user":{"login":"dorianmariefr","id":58794487,"node_id":"MDQ6VXNlcjU4Nzk0NDg3","avatar_url":"https://avatars.githubusercontent.com/u/58794487?v=4","gravatar_id":"","url":"https://api.github.com/users/dorianmariefr","html_url":"https://github.com/dorianmariefr","followers_url":"https://api.github.com/users/dorianmariefr/followers","following_url":"https://api.github.com/users/dorianmariefr/following{/other_user}","gists_url":"https://api.github.com/users/dorianmariefr/gists{/gist_id}","starred_url":"https://api.github.com/users/dorianmariefr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dorianmariefr/subscriptions","organizations_url":"https://api.github.com/users/dorianmariefr/orgs","repos_url":"https://api.github.com/users/dorianmariefr/repos","events_url":"https://api.github.com/users/dorianmariefr/events{/privacy}","received_events_url":"https://api.github.com/users/dorianmariefr/received_events","type":"User","site_admin":false},"labels":[{"id":123812746,"node_id":"MDU6TGFiZWwxMjM4MTI3NDY=","url":"https://api.github.com/repos/rails/rails/labels/activejob","name":"activejob","color":"5319e7","default":false,"description":null},{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null},{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-07-30T07:35:28Z","updated_at":"2021-07-30T08:44:04Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42914","html_url":"https://github.com/rails/rails/pull/42914","diff_url":"https://github.com/rails/rails/pull/42914.diff","patch_url":"https://github.com/rails/rails/pull/42914.patch"},"body":"### Summary\r\n\r\nTime.with_zone is more consistent with I18n.with_locale for instance\r\n\r\nI wanted to create a new alias but thought this should be the prefered way so I used it in the tests and in other part of rails's source code.\r\n\r\nFor instance, I wanted find this method so I tried `Time.with_zone` and it didn't exist so I implemented it myself in my app, now I know it exist but it will have better discoverability","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42913","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42913/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42913/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42913/events","html_url":"https://github.com/rails/rails/pull/42913","id":956168482,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk5ODA5MTY4","number":42913,"title":"Allow entirely opting out of deprecation warnings","user":{"login":"ghiculescu","id":509837,"node_id":"MDQ6VXNlcjUwOTgzNw==","avatar_url":"https://avatars.githubusercontent.com/u/509837?v=4","gravatar_id":"","url":"https://api.github.com/users/ghiculescu","html_url":"https://github.com/ghiculescu","followers_url":"https://api.github.com/users/ghiculescu/followers","following_url":"https://api.github.com/users/ghiculescu/following{/other_user}","gists_url":"https://api.github.com/users/ghiculescu/gists{/gist_id}","starred_url":"https://api.github.com/users/ghiculescu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghiculescu/subscriptions","organizations_url":"https://api.github.com/users/ghiculescu/orgs","repos_url":"https://api.github.com/users/ghiculescu/repos","events_url":"https://api.github.com/users/ghiculescu/events{/privacy}","received_events_url":"https://api.github.com/users/ghiculescu/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null},{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-07-29T20:07:24Z","updated_at":"2021-07-31T10:40:14Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42913","html_url":"https://github.com/rails/rails/pull/42913","diff_url":"https://github.com/rails/rails/pull/42913.diff","patch_url":"https://github.com/rails/rails/pull/42913.patch"},"body":"Previously if you did `app.config.active_support.deprecation = :silence`, some work would still be done on each call to `ActiveSupport::Deprecation.warn`. Specifically [checking the backtrace](https://github.com/rails/rails/blob/12372c54828e2ac04b230cedd5cbb75181e62d29/activesupport/lib/active_support/deprecation/reporting.rb#L21), generating the [deprecation warning](https://github.com/rails/rails/blob/12372c54828e2ac04b230cedd5cbb75181e62d29/activesupport/lib/active_support/deprecation/reporting.rb#L22), and [checking if the warning is disallowed](https://github.com/rails/rails/blob/12372c54828e2ac04b230cedd5cbb75181e62d29/activesupport/lib/active_support/deprecation/reporting.rb#L23).\r\n\r\nIn very hot paths, this could cause performance issues. This PR lets you turn off deprecation reporting entirely for a specific environment.\r\n\r\n```ruby\r\nconfig.active_support.report_deprecations = false\r\n```\r\n\r\n^ so has the same outcome as:\r\n\r\n```ruby\r\nconfig.active_support.deprecation = :silence\r\nconfig.active_support.disallowed_deprecation = :silence\r\n```\r\n\r\nBut it will short circuit [here](https://github.com/rails/rails/blob/12372c54828e2ac04b230cedd5cbb75181e62d29/activesupport/lib/active_support/deprecation/reporting.rb#L19).\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42912","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42912/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42912/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42912/events","html_url":"https://github.com/rails/rails/issues/42912","id":956153738,"node_id":"MDU6SXNzdWU5NTYxNTM3Mzg=","number":42912,"title":"`db:schema:load` does not restore the ActiveRecord::Base connection after running","user":{"login":"Taytay","id":1330693,"node_id":"MDQ6VXNlcjEzMzA2OTM=","avatar_url":"https://avatars.githubusercontent.com/u/1330693?v=4","gravatar_id":"","url":"https://api.github.com/users/Taytay","html_url":"https://github.com/Taytay","followers_url":"https://api.github.com/users/Taytay/followers","following_url":"https://api.github.com/users/Taytay/following{/other_user}","gists_url":"https://api.github.com/users/Taytay/gists{/gist_id}","starred_url":"https://api.github.com/users/Taytay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Taytay/subscriptions","organizations_url":"https://api.github.com/users/Taytay/orgs","repos_url":"https://api.github.com/users/Taytay/repos","events_url":"https://api.github.com/users/Taytay/events{/privacy}","received_events_url":"https://api.github.com/users/Taytay/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-07-29T19:45:03Z","updated_at":"2021-07-29T19:58:40Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I believe I've stumbled over a bug in the new rake tasks that allow for multi-database handling.\r\n\r\nSome of the tasks seem to clean up after themselves by re-establishing the connection for ActiveRecord::Base after they are done:\r\nhttps://github.com/rails/rails/blob/d9fda555942bfb6bcb1f75477b1425e2ab3162f5/activerecord/lib/active_record/railties/databases.rake#L106-L108\r\n\r\nHowever, the database-specific call to `load` (`db:schema:load:some_db_name`) does not re-establish a connection for ActiveRecord::Base in the rake file or in the underlying DatabaseTasks file:\r\nhttps://github.com/rails/rails/blob/d9fda555942bfb6bcb1f75477b1425e2ab3162f5/activerecord/lib/active_record/railties/databases.rake#L477-L480\r\n\r\nThis means that if you have a rake task (like we do) that invokes this task manually, it leaves ActiveRecord::Base connected to whatever database you happened to last call `db:schema:load` for.\r\n\r\nWe have a rake task that invokes other rake tasks, and that's how we ran into it.\r\nIn short, we are doing something like:\r\n```ruby\r\n# rake task preamble stuff...\r\n    Rake::Task['db:schema:load:non_primary_db'].invoke\r\n    # At this point, ActiveRecord::Base is still connected to that non-primary DB.\r\n    # Any calls we make to other rake tasks at this point that make use of `ActiveRecord::Base.connection` are going to get\r\n    # connected to the non_primary_db!\r\n\r\n    # So, this task might fail if it is relying upon the expected Rails behavior of respecting the ApplicationRecord's database configuration:\r\n    Rake::Task['some:custom:task'].invoke\r\n# ...\r\n```\r\n\r\nMy expectation/preference would be that any rake task run would be expected to _always_ clean up after itself if it ever modifies the ActiveRecord::Base. Is that a reasonable expectation, or am I doing something wrong?\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42910","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42910/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42910/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42910/events","html_url":"https://github.com/rails/rails/pull/42910","id":956125670,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk5NzcyNjg2","number":42910,"title":"Tidy ups to upgrade guide","user":{"login":"ghiculescu","id":509837,"node_id":"MDQ6VXNlcjUwOTgzNw==","avatar_url":"https://avatars.githubusercontent.com/u/509837?v=4","gravatar_id":"","url":"https://api.github.com/users/ghiculescu","html_url":"https://github.com/ghiculescu","followers_url":"https://api.github.com/users/ghiculescu/followers","following_url":"https://api.github.com/users/ghiculescu/following{/other_user}","gists_url":"https://api.github.com/users/ghiculescu/gists{/gist_id}","starred_url":"https://api.github.com/users/ghiculescu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghiculescu/subscriptions","organizations_url":"https://api.github.com/users/ghiculescu/orgs","repos_url":"https://api.github.com/users/ghiculescu/repos","events_url":"https://api.github.com/users/ghiculescu/events{/privacy}","received_events_url":"https://api.github.com/users/ghiculescu/received_events","type":"User","site_admin":false},"labels":[{"id":150377,"node_id":"MDU6TGFiZWwxNTAzNzc=","url":"https://api.github.com/repos/rails/rails/labels/docs","name":"docs","color":"02d7e1","default":false,"description":null},{"id":1072773639,"node_id":"MDU6TGFiZWwxMDcyNzczNjM5","url":"https://api.github.com/repos/rails/rails/labels/ready","name":"ready","color":"fef2c0","default":false,"description":"PRs ready to merge"}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-07-29T19:04:07Z","updated_at":"2021-07-31T02:10:51Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42910","html_url":"https://github.com/rails/rails/pull/42910","diff_url":"https://github.com/rails/rails/pull/42910.diff","patch_url":"https://github.com/rails/rails/pull/42910.patch"},"body":"Update some of the cop and code formatting in https://edgeguides.rubyonrails.org/upgrading_ruby_on_rails.html#activestorage-variant-processor-changed-to-vips\r\n\r\ncc @brenogazzola\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42909","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42909/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42909/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42909/events","html_url":"https://github.com/rails/rails/pull/42909","id":956097786,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk5NzQ5MDg5","number":42909,"title":"Add `skip_nil:` support to `RedisCacheStore`","user":{"login":"joeyparis","id":1377422,"node_id":"MDQ6VXNlcjEzNzc0MjI=","avatar_url":"https://avatars.githubusercontent.com/u/1377422?v=4","gravatar_id":"","url":"https://api.github.com/users/joeyparis","html_url":"https://github.com/joeyparis","followers_url":"https://api.github.com/users/joeyparis/followers","following_url":"https://api.github.com/users/joeyparis/following{/other_user}","gists_url":"https://api.github.com/users/joeyparis/gists{/gist_id}","starred_url":"https://api.github.com/users/joeyparis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joeyparis/subscriptions","organizations_url":"https://api.github.com/users/joeyparis/orgs","repos_url":"https://api.github.com/users/joeyparis/repos","events_url":"https://api.github.com/users/joeyparis/events{/privacy}","received_events_url":"https://api.github.com/users/joeyparis/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-07-29T18:24:35Z","updated_at":"2021-07-30T19:16:34Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42909","html_url":"https://github.com/rails/rails/pull/42909","diff_url":"https://github.com/rails/rails/pull/42909.diff","patch_url":"https://github.com/rails/rails/pull/42909.patch"},"body":"### Summary\r\n\r\n`ActiveSupport::Cache` accepts `skip_nil:` when initializing a cache to add to the default parameters of `fetch` requests. This pull request allows `RedisCacheStore` to also accept a default value for `skip_nil:`.\r\n\r\n### Other Information\r\n\r\nI copied the `skip_nil:` documentation from `ActiveSupport::Cache`, there might be a better way to write it so I'm definitely open to suggestions.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42908","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42908/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42908/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42908/events","html_url":"https://github.com/rails/rails/pull/42908","id":956094205,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk5NzQ2MDk2","number":42908,"title":"Update `ActiveRecord::Batches#in_batches` to make use of `ActiveRecord::Base.implicit_order_column` when present.","user":{"login":"HallDJack","id":1088410,"node_id":"MDQ6VXNlcjEwODg0MTA=","avatar_url":"https://avatars.githubusercontent.com/u/1088410?v=4","gravatar_id":"","url":"https://api.github.com/users/HallDJack","html_url":"https://github.com/HallDJack","followers_url":"https://api.github.com/users/HallDJack/followers","following_url":"https://api.github.com/users/HallDJack/following{/other_user}","gists_url":"https://api.github.com/users/HallDJack/gists{/gist_id}","starred_url":"https://api.github.com/users/HallDJack/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HallDJack/subscriptions","organizations_url":"https://api.github.com/users/HallDJack/orgs","repos_url":"https://api.github.com/users/HallDJack/repos","events_url":"https://api.github.com/users/HallDJack/events{/privacy}","received_events_url":"https://api.github.com/users/HallDJack/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-07-29T18:19:32Z","updated_at":"2021-07-30T21:25:32Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42908","html_url":"https://github.com/rails/rails/pull/42908","diff_url":"https://github.com/rails/rails/pull/42908.diff","patch_url":"https://github.com/rails/rails/pull/42908.patch"},"body":"### Summary\r\n\r\nWhen using `ActiveRecord::Batches#in_batches` ActiveRecord sorts records by primary key. This causes unpredictable behavior and errors when the primary key is not an auto-incrementing data type, like a UUID. \r\n\r\nThis change follows up on changes made in some earlier PRs (linked below) that made changes to the +first+ and +last+ finder calls. It updates `ActiveRecord::Batches#in_batches` so that it sorts by the `implicit_order_column` when that attribute has been configured. This allows for the batch processing of records that do not have an auto-incrementing primary key. Currently batch processing of a ActiveRecord model that has a UUID primary key does not consistently succeed.\r\n\r\nRelated PRs:\r\n- https://github.com/rails/rails/pull/34480\r\n- https://github.com/rails/rails/pull/37626\r\n\r\n### Other Information\r\n\r\nThe only slight difference in batch processing behavior comes when using batches with an `implicit_order_column` that is non-unique. In that case the batch size will represent the number of unique values to be processed in the batch not the number of records. For Example:\r\n\r\n  If the models's `implicit_order_column` has values of:\r\n  ```\r\n  [:a, :b, :c, :c, :d, :e, :f]\r\n  ```\r\n  And the user calls `Model.in_batches(of: 3)` the first batch will contain four records, `[:a, :b, :c, :c]`, and the second batch will contain the three remaining records, `[:d, :e, :f]`. No records will be skipped, barring any race conditions, but the number of records processed may vary between batches.\r\n\r\nWhile working on this patch I attempted to include subsorting by the primary key to remove this difference in behavior, but could not come up with something that worked and didn't change the interface to the `#in_batches` method. I think changes could be made to the ActiveRecord `PredicateBuilder` to allow for subsorting, but that is currently outside my comfort zone so I opted to not attempt those changes at this time. I feel that allowing batch processing even with this caveat is better than the current behavior. \r\n\r\nThis is my first time submitting a PR to Rails, so please let me know if I missed any steps, need to make additional changes, or add additional testing.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42907","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42907/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42907/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42907/events","html_url":"https://github.com/rails/rails/pull/42907","id":956003570,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk5NjY5NDAy","number":42907,"title":"Add ActiveModel::CompositeValidator","user":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","site_admin":false},"labels":[{"id":107190,"node_id":"MDU6TGFiZWwxMDcxOTA=","url":"https://api.github.com/repos/rails/rails/labels/activemodel","name":"activemodel","color":"00E5FF","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-07-29T16:18:22Z","updated_at":"2021-07-29T16:18:25Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42907","html_url":"https://github.com/rails/rails/pull/42907","diff_url":"https://github.com/rails/rails/pull/42907.diff","patch_url":"https://github.com/rails/rails/pull/42907.patch"},"body":"Based on the discussion in #41253.  `CompositeValidator` makes it easy to combine existing validators into a custom validator.  For example:\r\n\r\n```ruby\r\nclass MoneyValidator < ActiveModel::CompositeValidator\r\n  def compose\r\n    options[:attributes].each do |attribute|\r\n      validates attribute, numericality: { only_integer: true }\r\n      validates \"#{attribute}_currency\", inclusion: { in: %w(USD CNY JPY) }\r\n    end\r\n  end\r\nend\r\n```\r\n\r\nFor convenience, `CompositeValidator` forwards standard validation options, namely `:on`, `:if`, `:unless`, and `:strict`.  So the following would automatically apply `strict: true` to both the `numericality` and `inclusion` validations:\r\n\r\n```ruby\r\nclass Product < ApplicationRecord\r\n  validates :price, money: true, strict: true\r\nend\r\n```\r\n\r\n---\r\n\r\nTODO:\r\n- [ ] tests\r\n- [ ] docs\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42899","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42899/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42899/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42899/events","html_url":"https://github.com/rails/rails/pull/42899","id":955194439,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk4OTgwMTgz","number":42899,"title":"Add aliases for polymorphic associations","user":{"login":"mansakondo","id":47113995,"node_id":"MDQ6VXNlcjQ3MTEzOTk1","avatar_url":"https://avatars.githubusercontent.com/u/47113995?v=4","gravatar_id":"","url":"https://api.github.com/users/mansakondo","html_url":"https://github.com/mansakondo","followers_url":"https://api.github.com/users/mansakondo/followers","following_url":"https://api.github.com/users/mansakondo/following{/other_user}","gists_url":"https://api.github.com/users/mansakondo/gists{/gist_id}","starred_url":"https://api.github.com/users/mansakondo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mansakondo/subscriptions","organizations_url":"https://api.github.com/users/mansakondo/orgs","repos_url":"https://api.github.com/users/mansakondo/repos","events_url":"https://api.github.com/users/mansakondo/events{/privacy}","received_events_url":"https://api.github.com/users/mansakondo/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2021-07-28T20:06:24Z","updated_at":"2021-07-29T16:43:02Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42899","html_url":"https://github.com/rails/rails/pull/42899","diff_url":"https://github.com/rails/rails/pull/42899.diff","patch_url":"https://github.com/rails/rails/pull/42899.patch"},"body":"### Summary\r\nAs with [delegated types](https://edgeapi.rubyonrails.org/classes/ActiveRecord/DelegatedType.html#method-i-delegated_type), I'd like to define polymorphic associations like this:\r\n```ruby\r\n# app/models/review.rb\r\nclass Review < ActiveRecord::Base\r\n  belongs_to :reviewable, polymorphic: true, types: %w( Album Restaurant )\r\nend\r\n\r\n# app/models/album.rb\r\nclass Album < ActiveRecord::Base\r\n  has_many :reviews, as: :reviewable\r\nend\r\n\r\n# app/models/restaurant.rb\r\nclass Restaurant < ActiveRecord::Base\r\n  has_many :reviews, as: :reviewable\r\nend\r\n```\r\nAnd access them this way:\r\n```ruby\r\nReview#album\r\nReview#album=\r\nReview#reload_album\r\n\r\nReview#restaurant\r\nReview#restaurant=\r\nReview#reload_restaurant\r\n```\r\nI'll be waiting for your feedback to improve the code. Here's the initial issue: #42868.\r\n\r\n<!-- Provide a general description of the code changes in your pull\r\nrequest... were there any bugs you had fixed? If so, mention them. If\r\nthese bugs have open GitHub issues, be sure to tag them here as well,\r\nto keep the conversation linked together. -->\r\n\r\n<!-- If there's anything else that's important and relevant to your pull\r\nrequest, mention that information here. This could include\r\nbenchmarks, or other information.\r\n\r\nIf you are updating any of the CHANGELOG files or are asked to update the\r\nCHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.\r\n\r\nFinally, if your pull request affects documentation or any non-code\r\nchanges, guidelines for those changes are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)\r\n\r\nThanks for contributing to Rails! -->\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42883","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42883/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42883/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42883/events","html_url":"https://github.com/rails/rails/issues/42883","id":953841290,"node_id":"MDU6SXNzdWU5NTM4NDEyOTA=","number":42883,"title":"ActiveModel Errors - display detailed related model errors","user":{"login":"ltickett","id":4687431,"node_id":"MDQ6VXNlcjQ2ODc0MzE=","avatar_url":"https://avatars.githubusercontent.com/u/4687431?v=4","gravatar_id":"","url":"https://api.github.com/users/ltickett","html_url":"https://github.com/ltickett","followers_url":"https://api.github.com/users/ltickett/followers","following_url":"https://api.github.com/users/ltickett/following{/other_user}","gists_url":"https://api.github.com/users/ltickett/gists{/gist_id}","starred_url":"https://api.github.com/users/ltickett/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ltickett/subscriptions","organizations_url":"https://api.github.com/users/ltickett/orgs","repos_url":"https://api.github.com/users/ltickett/repos","events_url":"https://api.github.com/users/ltickett/events{/privacy}","received_events_url":"https://api.github.com/users/ltickett/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2021-07-27T12:40:34Z","updated_at":"2021-07-28T20:25:35Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Steps to reproduce\r\n<!-- (Guidelines for creating a bug report are [available\r\nhere](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->\r\n\r\nI'm working on the GitLab project, where we have the concept of `Issues`. An issue can have many `Timelogs`. \r\n\r\nIf I create an invalid timelog and check the `issue.errors` I get a rather unhelpful `attribute=timelogs, type=invalid`\r\n\r\nBut if I check the `timelog.errors` I get a helpful `summary, type=too_long`\r\n\r\n```ruby\r\npry(main)> i = Issue.first\r\n=> #<Issue id:1 gitlab-org/gitlab-test#1>\r\npry(main)> i.timelogs.create(time_spent: 600, summary: \"abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz\")\r\n=> #<Timelog:0x000055c4cfdc5a70\r\n id: nil,\r\n time_spent: 600,\r\n user_id: nil,\r\n created_at: nil,\r\n updated_at: nil,\r\n issue_id: 1,\r\n merge_request_id: nil,\r\n spent_at: nil,\r\n note_id: nil,\r\n project_id: nil,\r\n summary:\r\n  \"abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz\">\r\npry(main)> i.errors.errors\r\n=> [#<ActiveModel::Error attribute=timelogs, type=invalid, options={}>]\r\npry(main)> i.timelogs.first.errors.errors\r\n=> [#<ActiveModel::Error attribute=user, type=blank, options={}>, #<ActiveModel::Error attribute=summary, type=too_long, options={:count=>255}>]\r\n```\r\n\r\nCan we create an \"out of the box mechanism\" to view all of the detailed errors?\r\n\r\nI started building something, but realised:\r\n\r\n* i'm not qualfied for the job\r\n* there is likely already a way of doing it, I just don't know how\r\n\r\nForgive the duplication- but I previously posted on SO: https://stackoverflow.com/questions/68522570/get-hash-of-activerecord-errors-including-nested-children-relations-etc?noredirect=1#comment121124779_68522570\r\nAnd have also created an issue in the GitLab project: https://gitlab.com/gitlab-org/gitlab/-/issues/336970\r\n\r\nBut this feels like something that should be available natively?\r\n\r\nThanks!\r\n\r\n<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->\r\n```ruby\r\n# Your reproduction script goes here\r\n```\r\n\r\n### Expected behavior\r\n<!-- Tell us what should happen -->\r\n\r\n### Actual behavior\r\n<!-- Tell us what happens instead -->\r\n\r\n### System configuration\r\n**Rails version**: 6.1.3.2\r\n\r\n**Ruby version**: 2.7.2\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42882","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42882/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42882/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42882/events","html_url":"https://github.com/rails/rails/pull/42882","id":953736848,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk3NzMzODk5","number":42882,"title":"Revert \"Isolate descendants garbage collection test\"","user":{"login":"byroot","id":44640,"node_id":"MDQ6VXNlcjQ0NjQw","avatar_url":"https://avatars.githubusercontent.com/u/44640?v=4","gravatar_id":"","url":"https://api.github.com/users/byroot","html_url":"https://github.com/byroot","followers_url":"https://api.github.com/users/byroot/followers","following_url":"https://api.github.com/users/byroot/following{/other_user}","gists_url":"https://api.github.com/users/byroot/gists{/gist_id}","starred_url":"https://api.github.com/users/byroot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/byroot/subscriptions","organizations_url":"https://api.github.com/users/byroot/orgs","repos_url":"https://api.github.com/users/byroot/repos","events_url":"https://api.github.com/users/byroot/events{/privacy}","received_events_url":"https://api.github.com/users/byroot/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-07-27T10:26:59Z","updated_at":"2021-07-27T15:07:17Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42882","html_url":"https://github.com/rails/rails/pull/42882","diff_url":"https://github.com/rails/rails/pull/42882.diff","patch_url":"https://github.com/rails/rails/pull/42882.patch"},"body":"Reverts rails/rails#42845\r\n\r\nIt's very possible I was wrong on the stack references, let's see if we still need this workaround after https://github.com/rails/rails/pull/42881","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42879","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42879/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42879/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42879/events","html_url":"https://github.com/rails/rails/issues/42879","id":953252944,"node_id":"MDU6SXNzdWU5NTMyNTI5NDQ=","number":42879,"title":"Make reading_request? configurable in DatabaseSelector","user":{"login":"charlesvallieres","id":315979,"node_id":"MDQ6VXNlcjMxNTk3OQ==","avatar_url":"https://avatars.githubusercontent.com/u/315979?v=4","gravatar_id":"","url":"https://api.github.com/users/charlesvallieres","html_url":"https://github.com/charlesvallieres","followers_url":"https://api.github.com/users/charlesvallieres/followers","following_url":"https://api.github.com/users/charlesvallieres/following{/other_user}","gists_url":"https://api.github.com/users/charlesvallieres/gists{/gist_id}","starred_url":"https://api.github.com/users/charlesvallieres/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/charlesvallieres/subscriptions","organizations_url":"https://api.github.com/users/charlesvallieres/orgs","repos_url":"https://api.github.com/users/charlesvallieres/repos","events_url":"https://api.github.com/users/charlesvallieres/events{/privacy}","received_events_url":"https://api.github.com/users/charlesvallieres/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":true},"assignees":[{"login":"eileencodes","id":1080678,"node_id":"MDQ6VXNlcjEwODA2Nzg=","avatar_url":"https://avatars.githubusercontent.com/u/1080678?v=4","gravatar_id":"","url":"https://api.github.com/users/eileencodes","html_url":"https://github.com/eileencodes","followers_url":"https://api.github.com/users/eileencodes/followers","following_url":"https://api.github.com/users/eileencodes/following{/other_user}","gists_url":"https://api.github.com/users/eileencodes/gists{/gist_id}","starred_url":"https://api.github.com/users/eileencodes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eileencodes/subscriptions","organizations_url":"https://api.github.com/users/eileencodes/orgs","repos_url":"https://api.github.com/users/eileencodes/repos","events_url":"https://api.github.com/users/eileencodes/events{/privacy}","received_events_url":"https://api.github.com/users/eileencodes/received_events","type":"User","site_admin":true}],"milestone":null,"comments":1,"created_at":"2021-07-26T20:16:34Z","updated_at":"2021-07-27T12:34:19Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"### Context\r\n[`DatabaseSelector#reading_request?`](https://github.com/rails/rails/blob/main/activerecord/lib/active_record/middleware/database_selector.rb#L77-L79) considers GET and HEAD requests as reading and all other request types as writing, which is an excellent default.\r\n\r\nWhen using GraphQL ([graphql-ruby](https://github.com/rmosolgo/graphql-ruby)) all requests are passed as POST and it is not possible to configure the DatabaseSelector middleware to detect GraphQL queries as reading.\r\n\r\nI ended up writing an initializer that swaps the DatabaseSelector middleware with one that overwrites the `reading_request?` method which is not the end of the world, but I think it would be a nice feature to support the configuration of the `reading_request?` method directly in Rails.\r\n\r\n### Potential solutions\r\n#### Solution 1\r\nExpose the middleware class via configuration like the resolver and the context, this way users can extend the middleware and overwrite the condition :\r\n```ruby\r\nclass Application < Rails::Application\r\n  config.active_record.database_selector = { delay: 2.seconds }\r\n  config.active_record.database_selector_class = ActiveRecord::Middleware::DatabaseSelector\r\n  config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver\r\n  config.active_record.database_resolver_context = ActiveRecord::Middleware::DatabaseSelector::Resolver::Session\r\nend\r\n```\r\nNote : I don't like the `database_selector_class` key name because it is not consistent with `database_resolver` and `database_resolver_context` but it would be a breaking change to rename the existing `database_selector` to something like `database_selector_config`.\r\n\r\nAn alternative would be :\r\n```ruby\r\nconfig.active_record.database_selector = { delay: 2.seconds, class: ActiveRecord::Middleware::DatabaseSelector }\r\n```\r\n\r\n#### Solution 2\r\nMake `reading_request?` configurable via a proc :\r\n```ruby\r\nclass Application < Rails::Application\r\n  config.active_record.database_selector = { delay: 2.seconds, reading_condition: -> (request) { request.get? || request.head? } }\r\n  config.active_record.database_resolver = ActiveRecord::Middleware::DatabaseSelector::Resolver\r\n  config.active_record.database_resolver_context = ActiveRecord::Middleware::DatabaseSelector::Resolver::Session\r\nend\r\n```\r\n\r\nIf core members think this is a good idea I'd be willing to create a PR for the accepted solution.","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42877","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42877/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42877/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42877/events","html_url":"https://github.com/rails/rails/pull/42877","id":953064557,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk3MTY1MzIw","number":42877,"title":"Trigger full sweep when testing garbage collection","user":{"login":"jonathanhefner","id":771968,"node_id":"MDQ6VXNlcjc3MTk2OA==","avatar_url":"https://avatars.githubusercontent.com/u/771968?v=4","gravatar_id":"","url":"https://api.github.com/users/jonathanhefner","html_url":"https://github.com/jonathanhefner","followers_url":"https://api.github.com/users/jonathanhefner/followers","following_url":"https://api.github.com/users/jonathanhefner/following{/other_user}","gists_url":"https://api.github.com/users/jonathanhefner/gists{/gist_id}","starred_url":"https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jonathanhefner/subscriptions","organizations_url":"https://api.github.com/users/jonathanhefner/orgs","repos_url":"https://api.github.com/users/jonathanhefner/repos","events_url":"https://api.github.com/users/jonathanhefner/events{/privacy}","received_events_url":"https://api.github.com/users/jonathanhefner/received_events","type":"User","site_admin":false},"labels":[{"id":107194,"node_id":"MDU6TGFiZWwxMDcxOTQ=","url":"https://api.github.com/repos/rails/rails/labels/activesupport","name":"activesupport","color":"FC9300","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":17,"created_at":"2021-07-26T16:11:00Z","updated_at":"2021-07-27T08:48:26Z","closed_at":null,"author_association":"MEMBER","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42877","html_url":"https://github.com/rails/rails/pull/42877","diff_url":"https://github.com/rails/rails/pull/42877.diff","patch_url":"https://github.com/rails/rails/pull/42877.patch"},"body":"This ensures that the checker will be collected if it can be collected.\r\n\r\nThis addresses intermittent CI failures such as: https://buildkite.com/rails/rails/builds/79596#0051e91f-12bd-420f-979f-dd9c9ddb6f5b/1076-1085\r\n\r\n---\r\n\r\nI cannot reproduce the failure locally, so I am unsure whether this will completely fix it, but it is worth trying.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42875","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42875/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42875/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42875/events","html_url":"https://github.com/rails/rails/issues/42875","id":952862063,"node_id":"MDU6SXNzdWU5NTI4NjIwNjM=","number":42875,"title":"Wrap LocalCache around ActiveJob's","user":{"login":"chaffeqa","id":287640,"node_id":"MDQ6VXNlcjI4NzY0MA==","avatar_url":"https://avatars.githubusercontent.com/u/287640?v=4","gravatar_id":"","url":"https://api.github.com/users/chaffeqa","html_url":"https://github.com/chaffeqa","followers_url":"https://api.github.com/users/chaffeqa/followers","following_url":"https://api.github.com/users/chaffeqa/following{/other_user}","gists_url":"https://api.github.com/users/chaffeqa/gists{/gist_id}","starred_url":"https://api.github.com/users/chaffeqa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chaffeqa/subscriptions","organizations_url":"https://api.github.com/users/chaffeqa/orgs","repos_url":"https://api.github.com/users/chaffeqa/repos","events_url":"https://api.github.com/users/chaffeqa/events{/privacy}","received_events_url":"https://api.github.com/users/chaffeqa/received_events","type":"User","site_admin":false},"labels":[{"id":123812746,"node_id":"MDU6TGFiZWwxMjM4MTI3NDY=","url":"https://api.github.com/repos/rails/rails/labels/activejob","name":"activejob","color":"5319e7","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-07-26T12:42:23Z","updated_at":"2021-07-27T06:53:51Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I've been looking at the source to see if this is already being done and can't find it anywhere.  Proposal is:\r\n\r\nWrap `ActiveSupport::Cache::Strategy::LocalCache.with_local_cache` around `ActiveJob.perform`.\r\n\r\nSeems like it should be fairly straightforward, and may introduce nice performance wins.  Happy to assist if this makes sense!\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42874","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42874/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42874/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42874/events","html_url":"https://github.com/rails/rails/pull/42874","id":952778251,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk2OTIxMzkx","number":42874,"title":"Improvements to ActiveRecord::Rollback docs","user":{"login":"jjb","id":6097,"node_id":"MDQ6VXNlcjYwOTc=","avatar_url":"https://avatars.githubusercontent.com/u/6097?v=4","gravatar_id":"","url":"https://api.github.com/users/jjb","html_url":"https://github.com/jjb","followers_url":"https://api.github.com/users/jjb/followers","following_url":"https://api.github.com/users/jjb/following{/other_user}","gists_url":"https://api.github.com/users/jjb/gists{/gist_id}","starred_url":"https://api.github.com/users/jjb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jjb/subscriptions","organizations_url":"https://api.github.com/users/jjb/orgs","repos_url":"https://api.github.com/users/jjb/repos","events_url":"https://api.github.com/users/jjb/events{/privacy}","received_events_url":"https://api.github.com/users/jjb/received_events","type":"User","site_admin":false},"labels":[{"id":107191,"node_id":"MDU6TGFiZWwxMDcxOTE=","url":"https://api.github.com/repos/rails/rails/labels/activerecord","name":"activerecord","color":"0b02e1","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2021-07-26T11:01:48Z","updated_at":"2021-07-29T22:23:59Z","closed_at":null,"author_association":"CONTRIBUTOR","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42874","html_url":"https://github.com/rails/rails/pull/42874","diff_url":"https://github.com/rails/rails/pull/42874.diff","patch_url":"https://github.com/rails/rails/pull/42874.patch"},"body":"The main problem I wanted to solve is that the \"Call tech support\" message in the example is\r\nconfusing in this scenario, because it's addressing the user, but the user will never see it.\r\nI'm not sure if I'm not understanding something, or maybe this was copy/pasted from\r\nanother example years ago.\r\n\r\nHere I remove that and also expand the docs, hopefully illustrating the concept better.\r\n\r\nAny and all feedback on copy, phrasing, formatting, examples, is welcome!\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42872","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42872/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42872/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42872/events","html_url":"https://github.com/rails/rails/pull/42872","id":952354129,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk2NTYzMTAw","number":42872,"title":"[#42813] Render host_authorization debug view only for local requests","user":{"login":"nick-vyrko","id":1536587,"node_id":"MDQ6VXNlcjE1MzY1ODc=","avatar_url":"https://avatars.githubusercontent.com/u/1536587?v=4","gravatar_id":"","url":"https://api.github.com/users/nick-vyrko","html_url":"https://github.com/nick-vyrko","followers_url":"https://api.github.com/users/nick-vyrko/followers","following_url":"https://api.github.com/users/nick-vyrko/following{/other_user}","gists_url":"https://api.github.com/users/nick-vyrko/gists{/gist_id}","starred_url":"https://api.github.com/users/nick-vyrko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nick-vyrko/subscriptions","organizations_url":"https://api.github.com/users/nick-vyrko/orgs","repos_url":"https://api.github.com/users/nick-vyrko/repos","events_url":"https://api.github.com/users/nick-vyrko/events{/privacy}","received_events_url":"https://api.github.com/users/nick-vyrko/received_events","type":"User","site_admin":false},"labels":[{"id":107189,"node_id":"MDU6TGFiZWwxMDcxODk=","url":"https://api.github.com/repos/rails/rails/labels/actionpack","name":"actionpack","color":"FFF700","default":false,"description":null},{"id":107195,"node_id":"MDU6TGFiZWwxMDcxOTU=","url":"https://api.github.com/repos/rails/rails/labels/railties","name":"railties","color":"8BE06E","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-07-25T20:57:15Z","updated_at":"2021-07-31T20:58:29Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42872","html_url":"https://github.com/rails/rails/pull/42872","diff_url":"https://github.com/rails/rails/pull/42872.diff","patch_url":"https://github.com/rails/rails/pull/42872.patch"},"body":"### Summary\r\nResolves #42813 \r\nThe problem is that detailed information is rendered in PROD env in case of blocked host \r\n\r\n`HostAuthorization` middleware has been updated, to:\r\n\r\n- Respond with `HostAuthorization` debug view only when the `action_dispatch.show_detailed_exceptions`  header is set \r\n- Respond with an empty body and log the following message `'[HostAuthorization] Blocked host: <request.host>'` otherwise\r\n\r\n### Other Information\r\n\r\nThe chosen logging level is `info` . And I'm not sure it is not going to be a 'spam' in the log in case of a big amount of blocked requests\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42868","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42868/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42868/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42868/events","html_url":"https://github.com/rails/rails/issues/42868","id":952269631,"node_id":"MDU6SXNzdWU5NTIyNjk2MzE=","number":42868,"title":"Aliases for polymorphic associations like delegated types","user":{"login":"mansakondo","id":47113995,"node_id":"MDQ6VXNlcjQ3MTEzOTk1","avatar_url":"https://avatars.githubusercontent.com/u/47113995?v=4","gravatar_id":"","url":"https://api.github.com/users/mansakondo","html_url":"https://github.com/mansakondo","followers_url":"https://api.github.com/users/mansakondo/followers","following_url":"https://api.github.com/users/mansakondo/following{/other_user}","gists_url":"https://api.github.com/users/mansakondo/gists{/gist_id}","starred_url":"https://api.github.com/users/mansakondo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mansakondo/subscriptions","organizations_url":"https://api.github.com/users/mansakondo/orgs","repos_url":"https://api.github.com/users/mansakondo/repos","events_url":"https://api.github.com/users/mansakondo/events{/privacy}","received_events_url":"https://api.github.com/users/mansakondo/received_events","type":"User","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2021-07-25T12:59:35Z","updated_at":"2021-07-29T13:34:26Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"body":"I wanted to know if there's a particular reason why aliases for polymorphic associations (like delegated types) isn't implemented.","performed_via_github_app":null},{"url":"https://api.github.com/repos/rails/rails/issues/42865","repository_url":"https://api.github.com/repos/rails/rails","labels_url":"https://api.github.com/repos/rails/rails/issues/42865/labels{/name}","comments_url":"https://api.github.com/repos/rails/rails/issues/42865/comments","events_url":"https://api.github.com/repos/rails/rails/issues/42865/events","html_url":"https://github.com/rails/rails/pull/42865","id":952198943,"node_id":"MDExOlB1bGxSZXF1ZXN0Njk2NDQ0MTQ2","number":42865,"title":"Action cable auto disconnect","user":{"login":"hoppergee","id":15793005,"node_id":"MDQ6VXNlcjE1NzkzMDA1","avatar_url":"https://avatars.githubusercontent.com/u/15793005?v=4","gravatar_id":"","url":"https://api.github.com/users/hoppergee","html_url":"https://github.com/hoppergee","followers_url":"https://api.github.com/users/hoppergee/followers","following_url":"https://api.github.com/users/hoppergee/following{/other_user}","gists_url":"https://api.github.com/users/hoppergee/gists{/gist_id}","starred_url":"https://api.github.com/users/hoppergee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hoppergee/subscriptions","organizations_url":"https://api.github.com/users/hoppergee/orgs","repos_url":"https://api.github.com/users/hoppergee/repos","events_url":"https://api.github.com/users/hoppergee/events{/privacy}","received_events_url":"https://api.github.com/users/hoppergee/received_events","type":"User","site_admin":false},"labels":[{"id":300028327,"node_id":"MDU6TGFiZWwzMDAwMjgzMjc=","url":"https://api.github.com/repos/rails/rails/labels/actioncable","name":"actioncable","color":"bfdadc","default":false,"description":null}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2021-07-25T05:14:07Z","updated_at":"2021-07-27T01:16:56Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"pull_request":{"url":"https://api.github.com/repos/rails/rails/pulls/42865","html_url":"https://github.com/rails/rails/pull/42865","diff_url":"https://github.com/rails/rails/pull/42865.diff","patch_url":"https://github.com/rails/rails/pull/42865.patch"},"body":"### Summary\r\n\r\nRecently, I met a circumstance that I need to auto disconnect websocket when it's not be need.\r\n\r\n```javascript\r\nconst channel = {\r\n  channel: channel,\r\n  signed_stream_name: signed_stream_name,\r\n  expiresIn: 5000,\r\n  autoCloseWebsocket: true\r\n}\r\n\r\nsubscriptions.create(channel, mixin)\r\n```\r\n\r\nThen:\r\n- a subscription will auto unsubscribe after 5 seconds\r\n- Websocket connection will auto close if subscriptions array is empty\r\n","performed_via_github_app":null}]